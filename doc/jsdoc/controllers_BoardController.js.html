<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>DocStrap Source: controllers/BoardController.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.spacelab.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top navbar-inverse">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">DocStrap</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="module-AuthController%2520%25E8%25AA%258D%25E8%25A8%25BC%25E3%2582%25B3%25E3%2583%25B3%25E3%2583%2588%25E3%2583%25AD%25E3%2583%25BC%25E3%2583%25A9%25E3%2583%25BC.html">AuthController 認証コントローラー</a></li><li><a href="module-BoardController%2520%25E3%2583%259C%25E3%2583%25BC%25E3%2583%2589%25E3%2582%25B3%25E3%2583%25B3%25E3%2583%2588%25E3%2583%25AD%25E3%2583%25BC%25E3%2583%25A9%25E3%2583%25BC.html">BoardController ボードコントローラー</a></li><li><a href="module-DashboardController%2520%25E3%2583%259C%25E3%2583%25BC%25E3%2583%2589%25E3%2582%25B3%25E3%2583%25B3%25E3%2583%2588%25E3%2583%25AD%25E3%2583%25BC%25E3%2583%25A9%25E3%2583%25BC%25EF%25BC%2592.html">DashboardController ボードコントローラー２</a></li><li><a href="module-NewBoardController%2520%25E3%2583%259C%25E3%2583%25BC%25E3%2583%2589%25E6%2596%25B0%25E8%25A6%258F%25E4%25BD%259C%25E6%2588%2590%25E3%2582%25B3%25E3%2583%25B3%25E3%2583%2588%25E3%2583%25AD%25E3%2583%25BC%25E3%2583%25A9%25E3%2583%25BC.html">NewBoardController ボード新規作成コントローラー</a></li><li><a href="module-RESTController%2520REST%25E3%2582%25B3%25E3%2583%25B3%25E3%2583%2588%25E3%2583%25AD%25E3%2583%25BC%25E3%2583%25A9%25E3%2583%25BC.html">RESTController RESTコントローラー</a></li><li><a href="module-UserManageController%2520%25E3%2583%25A6%25E3%2583%25BC%25E3%2582%25B6%25E3%2583%25BC%25E7%25AE%25A1%25E7%2590%2586%25E3%2582%25B3%25E3%2583%25B3%25E3%2583%2588%25E3%2583%25AD%25E3%2583%25BC%25E3%2583%25A9%25E3%2583%25BC.html">UserManageController ユーザー管理コントローラー</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="global.html#crypto">crypto</a></li>
				</ul>
			</li>
			
		</ul>
		<div class="col-sm-3 col-md-3">
            <form class="navbar-form" role="search">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                    <div class="input-group-btn">
                        <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                    </div>
                </div>
            </form>
        </div>
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: controllers/BoardController.js</h1>
    
<section>
    <article>
        <pre
            class="sunlight-highlight-javascript linenums">/**
 * BoardController
 *
 * @module BoardController ボードコントローラー
 * @description :: Server-side logic for managing Boards
 * @help :: See http://links.sailsjs.org/docs/controllers
 */

var logger = require('../Log.js').getLoggerWrapper("BoardController");

var u = require('underscore');
var us = require('underscore.string');


/**
 * ブラウザから呼び出された場合に利用するコールバック関数.
 *
 * @param req
 *            リクエスト
 * @param res
 *            レスポンス
 * @param params
 *            パラメータ
 */
function getBrowserCallback(req, res, params){
	logger.trace(req, "getCreateBoardCallbackUI start");
	var type = params.type;
	var data = params.data;
	logger.trace(req, "結果処理コールバック関数呼び出し（ブラウザ）:" + JSON.stringify(data));
	switch(type){
	case "main":
		Utility.openMainPage(req, res, data);
		break;
	case "stay":
		var loginInfo = Utility.getLoginInfo(req, res);
		loginInfo.message = data;
		return res.view("newboard/index", {
			loginInfo: loginInfo,
			title: req.param("title"),
			category : req.param("category"),
			selectedId : req.param("selectedId"),
			desc: req.param('description')
		});
		break;
	case "stay2":
		var loginInfo = Utility.getLoginInfo(req, res);
		loginInfo.message = data;
		res.view("dashboard/editBoard", {
// id: req.param("boardId"),
// loginInfo: loginInfo,
// category: req.param("category"),
// categories: [],
// title: req.param("title"),
// description: req.param('description')

			id: id,
			title :found["title"],
			description:found["description"],
			width: found["width"],
			height: found["height"],
			bgType:found["bgType"],
			bgColor:found["bgColor"],
			bgImage:found["bgImage"],
			bgRepeatType: found["bgRepeatType"],
			bgSepV: found["bgSepV"],
			bgSepH: found["bgSepH"],
			bgSepLineWidth: found["bgSepLineWidth"],
			bgSepLineColor: found["bgSepLineColor"],
			images: backgroundFileList,
			category: found["category"] || "",
			categories: categories,
			selectedId : req.param("selectedId"),
			ticketTypeList : ticketTypeList,
			loginInfo: loginInfo

		});



		break;
	default:
		logger.error(req, "結果処理コールバックに与えられたタイプが想定外:[" + type + "]");
	}
	logger.trace(req, "getCreateBoardCallbackUI end");
}

/**
 * RESTから呼び出された場合に利用するコールバック関数.
 *
 * @param req
 *            リクエスト
 * @param res
 *            レスポンス
 * @param params
 *            パラメータ
 */
function getRESTCallback(req, res, params){
	logger.trace(req, "getCreateBoardCallbackREST start");
	var type = params.type;
	var data = params.data;
	logger.trace(req, "結果処理コールバック関数呼び出し（REST）:" + JSON.stringify(data));

	// REST結果に加工
	data = u.extend(data, {
		success: data["type"] === "success" ? true : false,
		message: data["contents"]});

	// 結果として利用しない項目の削除
	delete(data.type);
	delete(data.contents);
	res.json(data);
	logger.trace(req, "getCreateBoardCallbackREST end");
}

/**
 * 結果処理コールバック関数取得.&lt;br>
 *
 * ブラウザからの呼び出しか、RESTからの呼び出し化を判断し、適切なコールバック関数を返却する。
 *
 * @param req
 *            リクエスト
 * @param res
 *            レスポンス
 * @returns 結果処理コールバック関数
 */
function getCallback(req, res){
	logger.trace(req, "getCallback start");
	var loginInfo = Utility.getLoginInfo(req, res);

	// 処理実行がブラウザかRESTかに応じてコールバック関数を選択する。
	logger.trace(req, "アクセスモード:"+loginInfo.mode);
	var cb;
	if(loginInfo.mode == "browser"){
		cb = getBrowserCallback;
	} else {
		cb = getRESTCallback;
	}
	logger.trace(req, "getCallback end");
	return cb;
}


function trim(req, trimKeys){
	u.each(trimKeys, function(key){
		var value = req.param(key);
		req.params[key] = Utility.trim(req, value);
	});
}

function requiredItemCheck(req, res, requiredKeys, errorCb){
	var nullKeys = [];
	u.each(requiredKeys, function(obj){
		logger.debug(req, "必須チェック:"+obj.key+","+obj.name);
		var value = req.param(obj.key);
		logger.debug(req, "値["+value+"]");
		if(value == null || value === ""){
			nullKeys.push(obj.name);
		}
	});
	logger.debug(req, "数["+JSON.stringify(nullKeys)+"->"+nullKeys.length+"]");
	if(nullKeys.length > 0){
		// エラー用コールバックの実行
		errorCb(req, res, nullKeys);
		return false;
	}
	return true;
}

function setDefaultValues(req, newObj, defaultValues){
	u.each(defaultValues, function(v, k){
		var value = req.param(k)
		if(value == null){
			logger.debug(req, "デフォルト値の補完:" + k+" -> "+ v);
			value = v;
		}
		newObj[k] = value;
	});
}

function adminCheck(req, res, cb, loginInfo, message){
	logger.debug(req, "管理者権限チェック 開始");
	if(loginInfo["roleName"] !== "admin"){
		logger.debug(req, "管理者権限がないためエラーとする。");
		cb(req, res, {
			type: "main",
			data: {
				type: "danger",
				contents: message
			}
		});
		return false;
	}
	logger.debug(req, "管理者権限チェック 終了");
	return true;
}

/**
 * ボード作成内部処理.&lt;br>
 *
 * @param req
 *            リクエスト
 * @param res
 *            レスポンス
 * @param cb
 *            呼び出し方式（ブラウザ/REST）に応じて処理を分岐するためのコールバック関数
 */
function createBoardInner(req, res, cb) {
	var loginInfo = Utility.getLoginInfo(req, res);

	// 管理者ロールでない場合にはボードを作成できない。
	if(!adminCheck(req, res, cb, loginInfo, "一般ユーザーはボードを作成できません。")){
		return;
	};

	// タイトルとカテゴリをトリムする。
	var trimKeys = ["title", "category"];

	var requiredKeys = [{key: "title", name: "タイトル"}];

	var defaultValues = {
			"description": "",
			"category": "",
			"version": "1.1",
			"width": 3840,
			"height": 2160,
			"bgType": "image",
			"bgColor": "",
			"bgImage": "/images/background/common/background02.gif",
			"bgRepeatType": "repeat",
			"bgSepV": 1,
			"bgSepH": 1,
			"bgSepLineWidth": 3,
			"bgSepLineColor": "#000000",
			"ticketData": "ticket_blue_small:Keep:true,ticket_pink_small:Problem:true,ticket_yellow_small:Try:true,ticket_white_small:Memo:true",
	};

	trim(req, trimKeys);

	// 必須チェックエラーコールバック
	var errorCb = function(req, res, nullKeys){
		cb(req, res, {
			type: "main",
			data: {
				type: "danger",
				contents: "必須項目が未入力です：[" + nullKeys + "]"
			}
		});
	};

	if(!requiredItemCheck(req, res, requiredKeys, errorCb)){
		return;
	}

	// 値が未設定の場合には、デフォルト値を設定する。
	var newObj = {};
	setDefaultValues(req, newObj, defaultValues);

	// 内部設定項目
	newObj["title"] = req.param("title");
	newObj["projectId"] = loginInfo["projectId"], // 作成者のプロジェクトＩＤを引き継ぐ

	logger.debug(req, "★オブジェクト："+JSON.stringify(newObj));
	Board.create(newObj).exec(function(err, created){
		if(err) {
			cb(req, res, {
		    	  type: "stay",
		    	  data: {
		    		  type: "danger",
		    		  contents: "ボードの作成に失敗しました: " + JSON.stringify(err)
		    	  }
		      });
		    return;
		}
		cb(req, res, {
			type: "main",
			data: {
				type: "success",
				contents: "ボードを作成しました。［カテゴリ：" + req.param("category") + ", タイトル：" + req.param("title") + "］",
				board: created
			}
		});
	});
}

/**
 * ボード更新内部処理.&lt;br>
 *
 * @param req
 *            リクエスト
 * @param res
 *            レスポンス
 * @param cb
 *            呼び出し方式（ブラウザ/REST）に応じて処理を分岐するためのコールバック関数
 */
function updateBoardInner(req, res, cb) {
	logger.trace(req, "updateBoardInner start");
	var loginInfo = Utility.getLoginInfo(req, res);

	// 管理者ロールでない場合にはボードを更新できない。
	if(!adminCheck(req, res, cb, loginInfo, "一般ユーザーはボード情報を更新できません。")){
		return;
	};

	// ボードIDが指定されていない場合にはエラーとする。
	var requiredKeys = [
	                    {key: "boardId", name: "ボードＩＤ"}
	                    ];

	// タイトルが空文字の場合には、エラーとする。
	var title = req.param("title");

	if(title != null &amp;&amp; title.trim() === ""){
		cb(req, res, {
			type: "main",
			data: {
				type: "danger",
				contents: "空のタイトルに変更することはできません。]"
			}
		});
		return;
	};

	// 必須チェックエラーコールバック
	var errorCb = function(req, res, nullKeys){
		cb(req, res, {
			type: "main",
			data: {
				type: "danger",
				contents: "必須項目が未入力です：[" + nullKeys + "]"
			}
		});
	};

	if(!requiredItemCheck(req, res, requiredKeys, errorCb)){
		return;
	}

	var boardId = req.param('boardId');

	// 同一プロジェクトＩＤでない場合にはエラーとする。
	Board.findOne(boardId).exec(function(err, found){
		var loginInfo = Utility.getLoginInfo(req, res);
		if(err){
			cb(req, res, {
				type: "main",
				data: {
					type: "danger",
					contents: "ボード情報の更新に失敗しました: " + JSON.stringify(err)
				}
			});
			return;
	   	}
		if(loginInfo["projectId"] != found["projectId"]){
			cb(req, res, {
				type: "main",
				data: {
					type: "danger",
					contents: "ボード情報の更新に失敗しました（プロジェクトID不一致）"
				}
			});
			return;
		}

		// カテゴリ文字列をトリムする。
		var trimKeys = ["category"];
		trim(req, trimKeys);

		// 更新したい値を設定するオブジェクト
		var newObj = {};

		// 変更対象項目キー配列
		var keys = [
					'title',
					'description',
					'category',
					'width',
					'height',
					'bgType',
					'bgColor',
					'bgImage',
					'bgRepeatType',
					'bgSepV',
					'bgSepH',
					'bgSepLineWidth',
					'bgSepLineColor',
					'ticketData'
				];

		// 送信された値を更新する。
		u.each(keys, function(key){
			if(req.param(key)){
				newObj[key] = req.param(key);
			}
		});

		// ボードの更新処理
		Board.update(boardId, newObj).exec(function(err,created){
			if(err) {
				cb(req, res, {
					type: "main",
					data: {
						type: "danger",
						contents: "ボード情報の更新に失敗しました: " + JSON.stringify(err)
					}
				});
			    return;
			}
			cb(req, res, {
				type: "main",
				data: {
					type: "success",
					contents: "ボード情報を更新しました。"
				}
			});
			return;
		});
   });
}

/**
 * ボード削除処理
 */
function deleteBoardInner(req, res, cb) {
	logger.trace(req, "deleteBoardInner start");
	var loginInfo = Utility.getLoginInfo(req, res);

	// 管理者ロールでない場合にはボードを更新できない。
	if(!adminCheck(req, res, cb, loginInfo, "一般ユーザーはボード情報を更新できません。")){
		return;
	};

	// ボードIDが指定されていない場合にはエラーとする。
	var requiredKeys = [
	                    {key: "boardId", name: "ボードＩＤ"}
	                    ];

	// 必須チェックエラーコールバック
	var errorCb = function(req, res, nullKeys){
		cb(req, res, {
			type: "main",
			data: {
				type: "danger",
				contents: "必須項目が未入力です：[" + nullKeys + "]"
			}
		});
	};

	if(!requiredItemCheck(req, res, requiredKeys, errorCb)){
		return;
	}

	var boardId = req.param('boardId');

	// 同一プロジェクトＩＤでない場合にはエラーとする。
	Board.find({projectId: loginInfo["projectId"], id: boardId}).exec(function(err, found){
		var loginInfo = Utility.getLoginInfo(req, res);
		if(err) {
			cb(req, res, {
				type: "main",
				data: {
					type: "danger",
					contents: "ボード情報の削除に失敗しました: " + JSON.stringify(err)
				}
			});
			return;
	   	}

		Board.destroy(boardId).exec(function(err, found2){
			if(err || (found2 &amp;&amp; found2.length === 0)) {
				logger.error(req, "ボード削除処理 失敗: [" + boardId + ","+ JSON.stringify(err) + "]");
				cb(req, res, {
					type: "main",
					data: {
						type: "danger",
						contents: "ボード削除に失敗しました[" + boardId + "]"
					}
				});
				return;
			} else {
				logger.info(req, "ボード削除処理 成功: [" + boardId + "]");
				cb(req, res, {
					type: "main",
					data: {
						type: "success",
						contents: "ボードを削除しました: [" + found2[0]["title"] + "]"
					}
				});
				return;
			}

		});
   });
}


/**
 * ボード一覧取得処理
 */
function listBoardInner(req, res, cb) {
	logger.trace(req, "listBoardInner start");
	var loginInfo = Utility.getLoginInfo(req, res);

	// 必須チェックエラーコールバック
	var errorCb = function(req, res, nullKeys){
		cb(req, res, {
			type: "main",
			data: {
				type: "danger",
				contents: "必須項目が未入力です：[" + nullKeys + "]"
			}
		});
	};

	// クエリ条件
	var queryCondition = {projectId: loginInfo["projectId"]};

	// ボードID, タイトルが指定されている場合、条件に追加する。
	var conditionKeys = ["id", "title"];
	_.each(conditionKeys, function(key){
		var value = req.param(key);
		if(value != null){
			queryCondition[key] = value;
		}
	});

	Board.find(queryCondition).exec(function(err, found){
		var loginInfo = Utility.getLoginInfo(req, res);
		if(err) {
			cb(req, res, {
				type: "main",
				data: {
					type: "danger",
					contents: "ボード一覧取得に失敗しました: " + JSON.stringify(err)
				}
			});
			return;
	   	}

		logger.info(req, "ボード一覧取得処理 成功");
		cb(req, res, {
			type: "main",
			data: {
				type: "success",
				contents: "ボード一覧を取得しました",
				board: found
			}
		});
		return;

   });
}

/**
 * チケット作成処理.
 *
 * @param req
 *            リクエスト
 * @param res
 *            レスポンス
 * @param cb
 *            結果処理コールバック
 * @param loginInfo
 *            ログイン情報
 * @param boardId
 *            ボードＩＤ
 */
function createTicket(req, res, cb, loginInfo, boardId){
	var userId = req.param('userId');
	var socket = req.socket;
	var io = sails.io;
	var roomName = "room_"+boardId+"_";

	// デフォルト値データ
	var defaultValues = {
		contents: "",
		positionX: 0,
		positionY: 0,
		color: "ticket_blue_small",
		ticketHeight: 170,
		ticketWidth: 244
	};
	var newObj = {};
	setDefaultValues(req, newObj, defaultValues);
	newObj["boardId"] = boardId;
	newObj["createUser"] = userId;

	User.findOne(userId).exec(function(err, foundUser) {
		Ticket.create(newObj).exec(function(err, ticket) {
			if (err) {
				cb(req, res, {
					type: "main",
					data:{
						type: "danger",
						contents: "チケット作成に失敗しました。"+JSON.stringify(err)
					}
				});
			} else {
				io.sockets.in(roomName).emit('message', {
					action: "created",
					id: ticket.id,
					contents: ticket.contents,
					boardId: ticket.boardId,
					createUser : ticket.createUser,
					positionX: ticket.positionX,
					positionY: ticket.positionY,
					ticketHeight: ticket.ticketHeight,
					ticketWidth: ticket.ticketWidth,
					color: ticket.color,
					createdAt: ticket.createdAt,
					nickname : foundUser["nickname"]});
				cb(req, res, {
					type: "main",
					data:{
						type: "success",
						contents: "チケット作成に成功しました。",
						ticket: ticket
					}
				});
			}
		});
	});
}

/**
 * チケット削除処理.
 *
 * @param req
 *            リクエスト
 * @param res
 *            レスポンス
 * @param cb
 *            結果処理コールバック
 * @param loginInfo
 *            ログイン情報
 * @param boardId
 *            ボードＩＤ
 */
function deleteTicket(req, res, cb, loginInfo, boardId){
	var socket = req.socket;
	var io = sails.io;
	var roomName = "room_"+boardId+"_";
	var id = req.param('id');

	Ticket.findOne({boardId: boardId, id: id}).exec(function(err, found) {
		if(err){
			cb(req, res, {
				type: "main",
				data:{
					type: "danger",
					contents: "削除対象チケット取得に失敗しました。" + JSON.stringify(err)
				}
			});
			return;
		}
		Ticket.destroy({boardId: boardId, id: id}).exec(function(err2){
			if(err2){
				cb(req, res, {
					type: "main",
					data:{
						type: "danger",
						contents: "チケットの削除に失敗しました。" + JSON.stringify(err2)
					}
				});
				return;
			}
			if(found){
				io.sockets.in(roomName).emit('message', {
					action: "destroyed",
					id : found.id
				});
				cb(req, res, {
					type: "main",
					data:{
						type: "success",
						contents: "チケットを削除しました。"
					}
				});
			}
		});
	});
}

/**
 * チケット更新処理.
 *
 * @param req
 *            リクエスト
 * @param res
 *            レスポンス
 * @param cb
 *            結果処理コールバック
 * @param loginInfo
 *            ログイン情報
 * @param boardId
 *            ボードＩＤ
 */
function updateTicket(req, res, cb, loginInfo, boardId){
	var socket = req.socket;
	var io = sails.io;
	var roomName = "room_"+boardId+"_";
	var id = req.param('id');

	var x = req.param('positionX');
	var y = req.param('positionY');
	var ticketHeight = req.param('ticketHeight');
	var ticketWidth = req.param('ticketWidth');
	var contents = req.param('contents');

	var newObj = {};
	var keys = ["positionX", "positionY", "ticketHeight", "ticketWidth", "contents"];
	u.each(keys, function(key){
		var value = req.param(key);
		if(value != null){
			newObj[key] = value;
		}
	});
	Ticket.update({boardId: boardId, id : id}, newObj).exec(function update(err, updated) {

		if(err){
			cb(req, res, {
				type: "main",
				data:{
					type: "danger",
					contents: "チケットの更新に失敗しました。" + JSON.stringify(err)
				}
			});
			return;
		}
		logger.info(req, "チケット更新 成功: ["+JSON.stringify(updated[0])+"]");
		io.sockets.in(roomName).emit('message', {
			action : "updated",
			id : updated[0].id,
			positionX: updated[0].positionX,
			positionY: updated[0].positionY,
			ticketHeight: updated[0].ticketHeight,
			ticketWidth : updated[0].ticketWidth,
			contents: updated[0].contents
		});
		cb(req, res, {
			type: "main",
			data:{
				type: "success",
				contents: "チケットを更新しました。",
				ticket: updated[0]
			}
		});
	});

}

/**
 * チケット移動処理.
 *
 * チケットをボードから別なボードに移動する。
 *
 * @param req
 *            リクエスト
 * @param res
 *            レスポンス
 * @param cb
 *            結果処理コールバック
 * @param loginInfo
 *            ログイン情報
 * @param boardId
 *            ボードＩＤ
 */
function moveTicket(req, res, cb, loginInfo, boardId){
	var socket = req.socket;
	var io = sails.io;
	var roomName = "room_"+boardId+"_";
	var id = req.param('id');
	var nickname = req.param('nickname');

	// 移動先ボード
	var dstBoardId = req.param('dstBoardId');

	// 移動先ボードのプロジェクトＩＤがユーザーのプロジェクトＩＤに一致していない場合にはエラーとする。
	Board.findOne(dstBoardId).exec(function(err, found){
		if(err){
			cb(req, res, {
				type: "main",
				data:{
					type: "danger",
					contents: "チケット移動先ボードの取得に失敗しました。"+JSON.stringify(err)
				}
			});
			return
		}
		logger.debug(req, "移動先ボードのプロジェクトＩＤチェック:"+found["projectId"] +","+ loginInfo["projectId"]);
		if(found["projectId"] !== loginInfo["projectId"]){
			cb(req, res, {
				type: "main",
				data:{
					type: "danger",
					contents: "移動先ボードが存在しません。"
				}
			});
			return;
		}
		Ticket.update({boardId: boardId, id: id}, {boardId : dstBoardId}).exec(function update(err, updated){
			if(err){
				cb(req, res, {
					type: "main",
					data:{
						type: "danger",
						contents: "チケットの移動に失敗しました。" + JSON.stringify(err)
					}
				});
				return;
			}
			var ticket = updated[0];
			logger.debug(req, "チケット移動 成功: ["+JSON.stringify(ticket)+"]");

			// 移動元ボードに対してメッセージ通知
			io.sockets.in(roomName).emit('message',{action: "destroyed", id : id});

			// 移動先ボードに対してメッセージ通知
			io.sockets.in("room_" + dstBoardId).emit('message', {
				action: "created",
				id: id,
				contents: ticket.contents,
				boardId: ticket.boardId,
				createUser : ticket.createUser,
				positionX: ticket.positionX,
				positionY: ticket.positionY,
				ticketHeight: ticket.ticketHeight,
				ticketWidth : ticket.ticketWidth,
				color: ticket.color,
				nickname : nickname
			});
			cb(req, res, {
				type: "main",
				data:{
					type: "success",
					contents: "チケットを移動しました。"
				}
			});
		})
	})
}



/**
 * チケット一覧取得処理
 */
function listTicketInner(req, res, cb) {
	logger.trace(req, "listTicketInner start");
	var loginInfo = Utility.getLoginInfo(req, res);



	// 必須チェックエラーコールバック
	var errorCb = function(req, res, nullKeys){
		cb(req, res, {
			type: "main",
			data: {
				type: "danger",
				contents: "必須項目が未入力です：[" + nullKeys + "]"
			}
		});
	};

	// ボードID、もしくは、ボードタイトルが指定されていない場合にはエラーとする。
	var boardId = req.param("boardId");
	var boardTitle = req.param("boardTitle");
	if(boardId == null &amp;&amp; boardTitle == null){
		cb(req, res, {
			type: "main",
			data: {
				type: "danger",
				contents: "ボードＩＤ(boardId)、もしくは、ボードタイトル(boardTitle)の入力が必要です"
			}
		});
	}

	// クエリ条件
	var queryCondition = {projectId: loginInfo["projectId"]};

	// ボードID, タイトルが指定されている場合、条件に追加する。
	if(boardId != null){
		queryCondition["id"] = boardId;
	}
	if(boardTitle != null){
		queryCondition["title"] = boardTitle;
	}

	logger.debug(req, "チケット取得条件:"+JSON.stringify(queryCondition));
	Board.find(queryCondition).exec(function(err, found){
		var loginInfo = Utility.getLoginInfo(req, res);
		if(err) {
			cb(req, res, {
				type: "main",
				data: {
					type: "danger",
					contents: "ボード取得に失敗しました: " + JSON.stringify(err)
				}
			});
			return;
	   	}

		if(found.length == 0){
			cb(req, res, {
				type: "main",
				data: {
					type: "danger",
					contents: "指定したボードは存在しません"
				}
			});
			return;
		}
		// チケット一覧取得元ボード
		// チケットタイトルを条件とした場合には、複数のボードが取得される可能性があるが、先頭のものと対象とする。
		var targetBoard = found[0];

		logger.info(req, "ボード取得処理 成功");
		Ticket.find({boardId: targetBoard["id"]}).exec(function(err2, found2){
			if(err2) {
				cb(req, res, {
					type: "main",
					data: {
						type: "danger",
						contents: "チケット一覧の取得に失敗しました: " + JSON.stringify(err2)
					}
				});
				return;
		   	}

			cb(req, res, {
				type: "main",
				data: {
					type: "success",
					contents: "チケット一覧を取得しました",
					ticket: found2
				}
			});
			return;
		});

   });
}


module.exports = {

	/**
	 * リスナ登録
	 */
	register : function(req, res) {
		var boardId = req.param('boardId');
		logger.trace(req, "register called: [" + boardId + "]");
		var socket = req.socket;
		var io = sails.io;

		// リスナ登録
		var roomName = 'room_'+boardId+'_';
		logger.debug(req, "リスナ登録: [" + roomName + "]");
		socket.join(roomName);
		if(req.session.passport){
			var userId = req.session.passport.userId;
			BoardUserManager.addBoardUser(req, roomName, userId);
			var usersInRoom = BoardUserManager.getBoardUserInfo(req, roomName);
			io.sockets.in(roomName).emit('message', {action : "enter", userId: userId, users: usersInRoom});
		}
	},

    /**
	 * ボード作成
	 */
    createBoard : function(req, res) {
    	var cb = getCallback(req, res);
    	createBoardInner(req, res, cb);
    },

    /**
	 * ボード情報更新
	 */
    updateBoard : function(req, res) {
     	var cb = getCallback(req, res);
     	updateBoardInner(req, res, cb);
    },

    /**
	 * ボード情報削除
	 */
    deleteBoard : function(req, res) {
     	var cb = getCallback(req, res);
     	deleteBoardInner(req, res, cb);
    },

    /**
	 * ボード一覧取得
	 */
    listBoard : function(req, res) {
     	var cb = getCallback(req, res);
     	listBoardInner(req, res, cb);
    },

	/**
	 * チケット共通処理.
	 *
	 * @param req
	 *            リクエスト
	 * @param res
	 *            レスポンス
	 */
	process : function(req, res) {
		var loginInfo = Utility.getLoginInfo(req, res);

		// 結果処理コールバックを取得
		var cb;
		logger.debug(req, "モード["+loginInfo.mode+"]");
		if(loginInfo.mode === "rest"){
			cb = getRESTCallback;
		} else {
			cb = function(req, res, params){
				logger.debug(req, "チケット処理:"+JSON.stringify(params));
			};
		}

		var actionType = req.param('actionType');

		// チケット新規作成以外の場合には、チケットＩＤの必須チェックを行う。
		if(actionType !== "create"){
			var id = req.param('id');
			if(id == null){
				cb(req, res, {
					type: "main",
					data:{
						type: "danger",
						contents: "チケットＩＤが指定されていません。"
					}
				});
				return;
			}
		}

		var boardId = req.param('boardId');
		// ボードＩＤの必須チェック
		if(boardId == null || boardId === ""){
			cb(req, res, {
				type: "main",
				data:{
					type: "danger",
					contents: "ボードIDが指定されていません"
				}
			});
			return;
		}

		// ボードのプロジェクトＩＤがユーザーのプロジェクトＩＤに一致していない場合にはエラーとする。
		Board.findOne(boardId).exec(function(err, found){
			if(err){
				cb(req, res, {
					type: "main",
					data:{
						type: "danger",
						contents: "チケット作成ボードの取得に失敗しました。"+JSON.stringify(err)
					}
				});
				return
			}
			logger.debug(req, "プロジェクトＩＤチェック:"+found["projectId"] +","+ loginInfo["projectId"]);
			if(found["projectId"] !== loginInfo["projectId"]){
				cb(req, res, {
					type: "main",
					data:{
						type: "danger",
						contents: "チケット作成ボードが存在しません。"
					}
				});
				return;
			}

			logger.debug(req, "チケット処理:["+actionType+"]["+id+"]["+boardId+"]");

			switch(actionType){
			case "create":
				// チケット作成
				createTicket(req, res, cb, loginInfo, boardId);
				break;
			case "destroy":
				deleteTicket(req, res, cb, loginInfo, boardId);
				break;
			case "update":
				updateTicket(req, res, cb, loginInfo, boardId);
				break;
			case "move":
				moveTicket(req, res, cb, loginInfo, boardId);
				break;
			default:
				logger.error(req, "チケット処理 想定外のアクション:[" + actionType + "]");
			}
		});
	},

    /**
	 * チケット一覧取得
	 */
    listTicket : function(req, res) {
     	var cb = getCallback(req, res);
     	listTicketInner(req, res, cb);
    }

}

</pre>
    </article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>

<div class="modal fade" id="searchResults">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Search results</h4>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div>

<footer>


	<span class="copyright">
	DocStrap Copyright © 2012-2015 The contributors to the JSDoc3 and DocStrap projects.
	</span>

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a>
	
		on Sun Jul 10th 2016
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>
<script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>

<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			var id = $( heading ).attr( "id" );
			return id && id.replace(/\~/g, '-inner-').replace(/\./g, '-static-') || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->


<script type="text/javascript">
	$(document).ready(function() {
		SearcherDisplay.init();
	});
</script>

</body>
</html>
