<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>DocStrap Source: controllers/DashboardController.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.spacelab.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top navbar-inverse">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">DocStrap</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="module-AuthController%2520%25E8%25AA%258D%25E8%25A8%25BC%25E3%2582%25B3%25E3%2583%25B3%25E3%2583%2588%25E3%2583%25AD%25E3%2583%25BC%25E3%2583%25A9%25E3%2583%25BC.html">AuthController 認証コントローラー</a></li><li><a href="module-BoardController%2520%25E3%2583%259C%25E3%2583%25BC%25E3%2583%2589%25E3%2582%25B3%25E3%2583%25B3%25E3%2583%2588%25E3%2583%25AD%25E3%2583%25BC%25E3%2583%25A9%25E3%2583%25BC.html">BoardController ボードコントローラー</a></li><li><a href="module-DashboardController%2520%25E3%2583%259C%25E3%2583%25BC%25E3%2583%2589%25E3%2582%25B3%25E3%2583%25B3%25E3%2583%2588%25E3%2583%25AD%25E3%2583%25BC%25E3%2583%25A9%25E3%2583%25BC%25EF%25BC%2592.html">DashboardController ボードコントローラー２</a></li><li><a href="module-NewBoardController%2520%25E3%2583%259C%25E3%2583%25BC%25E3%2583%2589%25E6%2596%25B0%25E8%25A6%258F%25E4%25BD%259C%25E6%2588%2590%25E3%2582%25B3%25E3%2583%25B3%25E3%2583%2588%25E3%2583%25AD%25E3%2583%25BC%25E3%2583%25A9%25E3%2583%25BC.html">NewBoardController ボード新規作成コントローラー</a></li><li><a href="module-RESTController%2520REST%25E3%2582%25B3%25E3%2583%25B3%25E3%2583%2588%25E3%2583%25AD%25E3%2583%25BC%25E3%2583%25A9%25E3%2583%25BC.html">RESTController RESTコントローラー</a></li><li><a href="module-UserManageController%2520%25E3%2583%25A6%25E3%2583%25BC%25E3%2582%25B6%25E3%2583%25BC%25E7%25AE%25A1%25E7%2590%2586%25E3%2582%25B3%25E3%2583%25B3%25E3%2583%2588%25E3%2583%25AD%25E3%2583%25BC%25E3%2583%25A9%25E3%2583%25BC.html">UserManageController ユーザー管理コントローラー</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="global.html" class="dropdown-toggle" data-toggle="dropdown">Global<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="global.html#crypto">crypto</a></li>
				</ul>
			</li>
			
		</ul>
		<div class="col-sm-3 col-md-3">
            <form class="navbar-form" role="search">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                    <div class="input-group-btn">
                        <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                    </div>
                </div>
            </form>
        </div>
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: controllers/DashboardController.js</h1>
    
<section>
    <article>
        <pre
            class="sunlight-highlight-javascript linenums">/**
 * DashboardController
 *
 * @module DashboardController ボードコントローラー２
 * @description :: Server-side logic for managing dashboards
 * @help        :: See http://links.sailsjs.org/docs/controllers
 */

var u = require('underscore');
var us = require('underscore.string');
var fs = require('fs');
var path = require('path');

var logger = require('../Log.js').getLoggerWrapper("DashboardController");

// 背景画像を格納するパス
var BACKGROUND_REL_PATH = "/images/background/";

// 画像ファイルとして許容する拡張子
var IMAGE_FILE_EXTENSIONS = ["JPG", "GIF", "PNG", "BMP"];

function getBackgroundDir(req, res){
	var loginInfo = Utility.getLoginInfo(req, res);
	var projectId = loginInfo["projectId"];
	var path = './upload' + BACKGROUND_REL_PATH+ projectId + "/";
	return path;
}

// 資産フォルダ
var ASSETS = "assets";

// ファイルアップロードと同時に背景画像を変更したい場合にはtrueにする。
var flagChangeBackgroundImage = false;

// 背景情報のデフォルト値
var BOARD_DEFAULT_VALUES = {
	version : '1.1',
 	width : 3840,
    height : 2160,
    bgType : 'image',
    bgColor : '',
    bgImage : BACKGROUND_REL_PATH + 'background02.gif',
    bgRepeatType :  'repeat',
    bgSepV : 1,
    bgSepH : 1,
    bgSepLineWidth : 3,
    bgSepLineColor : '#000000',
    ticketData : 'ticket_blue_small:Keep:true,ticket_pink_small:Problem:true,ticket_yellow_small:Try:true,ticket_white_small:Memo:true'
};

var ticketData0 = [
   				{id: "ticket_blue_small", label: "青（小）"},
//				{id: "ticket_blue_big", label: "青（大）"},
				{id: "ticket_pink_small", label: "ピンク（小）"},
//				{id: "ticket_pink_big", label: "ピンク（大）"},
				{id: "ticket_yellow_small", label: "黄（小）"},
//				{id: "ticket_yellow_big", label: "黄（大）"},
				{id: "ticket_white_small", label: "白（小）"}
//				{id: "ticket_white_big", label: "白（大）"},
//				{id: "ticket_brown_small", label: "茶（小）"},
//				{id: "ticket_brown_big", label: "茶（大）"},
//				{id: "ticket_gray_small", label: "灰色（小）"},
//				{id: "ticket_gray_big", label: "灰（大）"},
//				{id: "ticket_green_small", label: "緑（小）"},
//				{id: "ticket_green_big", label: "緑（大）"},
//				{id: "ticket_orange_small", label: "オレンジ（小）"},
//				{id: "ticket_orange_big", label: "オレンジ（大）"},
//				{id: "ticket_purple_small", label: "紫（小）"},
//				{id: "ticket_purple_big", label: "紫（大）"}
			];

/**
 * 利用可能付箋タイプ一覧のデータを作成する。
 * @param req
 * @param ticketData2
 * @returns {String}
 */
function createTicketTypeString(req, ticketData2){
	var ret = "";
	var ticketData = createTicketDataArray(req, ticketData2);
	u.each(ticketData, function(d){
		var id = d["id"];
		ret += '&lt;tr class="ticketDataRow" id="' + id + '">'
		+'&lt;td style="text-align:center;vertical-align:middle;">'
		+'&lt;label for="check_' + id + '" style="width:100%;">'
		+'&lt;input class="ticketDataCheck" id="check_' + id + '" type="checkbox" ' + d["state"] + '/>&lt;/label>&lt;/td>'
		+'&lt;td style="vertical-align:middle;" class="ticketDataType">' + d["label"] + '&lt;/td>'
		+'&lt;td style="vertical-align:middle;">&lt;input class="ticketDataName" style="width:100%;" value="' + d["name"] + '"/>&lt;/td>';
		+'&lt;/tr>';
	});
	return ret;
}

/**
 * 利用可能付箋データ文字列を配列に変換する。
 * @param ticketData2 利用可能付箋データ文字列
 * @returns {Array} 利用可能付箋データ配列
 */
function createTicketDataArray(req, ticketData2) {
	var ticketData = [];
	var items;
	if(ticketData2){
		if(u.contains(ticketData2, ",")){
			items = ticketData2.split(",");
		} else {
			items = [ticketData2];
		}
	} else {
		items = [];
	}
	var map = {};
	u.each(items, function(item){
		var items2 = item.split(":");
		map[items2[0]] = {name: items2[1], state: items2[2] === "true" ? "checked" : ""};
	});
	u.each(ticketData0, function(d){
		var m = map[d["id"]];
		d["name"] = m ? m["name"] : "";
		d["state"] = m ? m["state"] : "";
		ticketData.push(d);
	});
	return ticketData;
}

function showEditView(req, res, id, loginInfo){
	logger.trace(req, "showEditView called: [" + id + "]");

	// 管理者ロールでない場合には、ボード作成画面を表示しない。
	if(loginInfo["roleName"] !== "admin"){
		logger.error(req, "一般ユーザーは更新画面を表示できません。");
		message = {type: "danger", contents: "画面の表示に失敗しました。"};
		Utility.openMainPage(req, res, message);
		return;
	}

	Board.findOne(id).exec(function(err,found){
	    if(err || !found || loginInfo["projectId"] !== found["projectId"]) {
			logger.error(req, "ボード編集時 ボード取得失敗: エラー発生: [" + JSON.stringify(err) + "]");
			Utility.openMainPage(req, res, {type: "danger", contents: "エラーが発生しました:"+JSON.stringify(err)});
			return;
		} else {
			logger.debug(req, "編集対象ボード取得[" + JSON.stringify(found) + "]");
			fs.readdir(getBackgroundDir(req, res), function(err, files){
				if (err) {
					throw err;
				}
				var backgroundFileList = [];
				files.filter(function(file){
					return fs.statSync(getBackgroundDir(req, res) + file).isFile();
				}).forEach(function (file) {
					backgroundFileList.push(BACKGROUND_REL_PATH + loginInfo["projectId"]+"/" +file);
				});
				logger.debug(req, backgroundFileList);
				var ticketData2 = found["ticketData"] || BOARD_DEFAULT_VALUES["ticketData"];
				var ticketTypeList = createTicketTypeString(req, ticketData2);
				var successCb = function(categories){
					res.view('dashboard/editBoard', { id: id,
						title :found["title"],
						description:found["description"],
						width: found["width"],
						height: found["height"],
						bgType:found["bgType"],
						bgColor:found["bgColor"],
						bgImage:found["bgImage"],
						bgRepeatType: found["bgRepeatType"],
						bgSepV: found["bgSepV"],
						bgSepH: found["bgSepH"],
						bgSepLineWidth: found["bgSepLineWidth"],
						bgSepLineColor: found["bgSepLineColor"],
						images: backgroundFileList,
						category: found["category"] || "",
						categories: categories,
						selectedId : req.param("selectedId"),
						ticketTypeList : ticketTypeList,
						loginInfo: loginInfo
					});
				}
				var errorCb = function(err){
					logger.error(req, "ボード情報の取得に失敗しました。"+JSON.stringify(err));
				    message = {type: "danger", contents: "ボード情報の取得に失敗しました。"};
					Utility.openMainPage(req, res, message);
				};
				Utility.getCategoryList(req, res, successCb, errorCb);
			});
		}
	});
}

function processDeleteImagePath(path){
	var ret = null;
	if(path == null){
		return ret;
	}
	if(!us.startsWith(path, "/")){
		return ret;
	}
	if(us.contains(path, "..")){
		return ret;
	}
	var items = path.split("/");
	if(items.length != 5){
		return ret;
	}
	var dirName = items[3];
	var fileName = items[4];
	ret = {dirName: dirName, fileName: fileName};
	return ret;

}
module.exports = {

	/**
	 * ボード一覧画面を開く
	 */
    index : function(req, res) {
	    logger.trace(req, "index called");
		var loginInfo = Utility.getLoginInfo(req, res);
		var message;
		Board.find({projectId: loginInfo["projectId"]}).sort({"title":-1}).exec(function(err, found) {
			// ボードリストの取得に失敗した場合にはエラーメッセージを表示する。
			if(err){
				logger.error(req, "ボード一覧画面オープン時にエラー発生[" + JSON.stringify(err) +"]");
				found = [];
				message = {type: "danger", contents: "ボード一覧画面の表示に失敗しました。"};
				loginInfo.message = message;
				res.view({
					list: found,
					loginInfo: loginInfo
				});
				return;
			}

			// 同期処理関数を作成
			var wait = function (callbacks, done) {
				var counter = callbacks.length;
				if(counter > 0){
					var next = function() {
						if (--counter == 0) {
							done();
						}
					};
					for (var i=0; i &lt; callbacks.length; i++) {
						callbacks[i](next);
					};
				} else {
					done();
				}
			};

			// 第1段階で終了すべき関数
			var prerequisite = [];

			// ボードリストを取得した場合、必要に応じてボード情報のマイグレーションを行う。
			// 取得したボード情報にバージョンが指定されていない場合にはマイグレーション対象とする。
			var ngIds = [];
			for (var i = 0; i &lt; found.length; i++) {
				if (found[i]["version"] === undefined) {
					// i番目のボードに関する処理を即時評価とクロージャーで作成し、同期実行配列に追加する。
					(function(num){
						prerequisite.push(function(next) {
							logger.info(req, "マイグレーション処理 開始");
							var board = found[num];
							var boardId = board["id"];
							logger.info(req, "マイグレーション対象ボード[" + boardId + "]");
							logger.info(req, "マイグレーション前[" + JSON.stringify(board) + "]");

							// 値が未指定の場合にはデフォルト値を設定する。
							var newBoard = u.defaults(_.clone(board), BOARD_DEFAULT_VALUES);
							delete newBoard["id"];
							delete newBoard["createdAt"];
							delete newBoard["updatedAt"];
							logger.info(req, "マイグレーション後[" + JSON.stringify(newBoard) + "]");

							// テーブル内容の更新
							Board.update(boardId, newBoard).exec(function(err2, updated) {
								if(err2) {
									logger.error(req, "ボード情報のマイグレーションに失敗しました:[" + boardId + "]: " + JSON.stringify(err2));
									ngIds.push(boardId);
								} else {
									logger.info(req, "ボード情報のマイグレーションに成功[" + boardId + "]");
								}
								logger.info(req, "マイグレーション処理 終了");
								next();
							});
						})
					})(i);
				}
			};

			// 第２段階処理
			var done = function() {
				logger.trace(req, "ボード一覧画面表示処理 開始");
				if(ngIds.length > 0){
					loginInfo.message = {type: "danger", contents: "ボード情報のマイグレーションに失敗しました：[" + ngIds + "]"};
				}
				var categoryData = Utility.getCategoryMap(found);
				res.view({
					categoryData: JSON.stringify(categoryData),
					category : req.param("category"),
					selectedId : req.param("selectedId"),
					loginInfo: loginInfo
				});
				logger.trace(req, "ボード一覧画面表示処理 終了");
			};

			// 同期処理実行
			wait(prerequisite, done);
		});
    },

    /**
     * ボード画面を開く
     */
    openBoard2 : function(req, res) {
	var boardId = req.param("selectedId");
    logger.trace(req, "openBoard2 called: ["+boardId+"]");
	var loginInfo = Utility.getLoginInfo(req, res);
    var message = null;

	 //コンボボックスメニューHTML
	 var comboMenu;

	 // コンテクストメニューHTML
	 var contextMenu = "";

	if(!boardId){
	    logger.warn(req, "ボードIDが存在しないためボード選択画面に遷移。");
		message = {type: "warn", contents: "ボードIDが指定されていません。"};
		Utility.openMainPage(req, res, message);
	    return;
	}

	var wait = function (callbacks, done) {
		var counter = callbacks.length;
		if(counter > 0){
			var next = function() {
				if (--counter == 0) {
					done();
				}
			};
			for (var i=0; i &lt; callbacks.length; i++) {
				callbacks[i](next);
			};
		} else {
			done();
		}
	}

	Board.findOne(boardId).exec(function(err,found){
		if(err){
			logger.error(req, "エラー発生: [" + JSON.stringify(err) + "]");
		    message = {type: "danger", contents: "エラーが発生しました[" + boardId + "]"};
			Utility.openMainPage(req, res, message);
			return;
		}
		if(!found || loginInfo["projectId"] !== found["projectId"]) {
			logger.error(req, "指定されたボードIDが存在しないため、ボード選択画面に遷移[" + boardId + "]");
			message = {type: "warn", contents: "指定したボードIDが存在しません[" + boardId + "]"};
			Utility.openMainPage(req, res, message);
			return;
	    }
	    Ticket.find({boardId : boardId}).exec(function(err2, tickets) {

		// 第1段階で終了すべき関数を格納する。
		var prerequisite = [];

		// ニックネーム対応マップ（ユーザーIDとニックネームを対応させる）
		var userIdToNicknameMap = {};

		// 全ユーザーリストを取得しニックネーム対応マップを作成する。
		prerequisite.push(function(next) {
			// ログインユーザーと同一のプロジェクトＩＤをもつユーザーを取得
			 User.find({projectId: loginInfo["projectId"]}).exec(function(err3, usersFound) {
				if(err3){
					logger.error(req, "チケットのユーザーIDの検索: エラー発生:" + JSON.stringify(err3));
				} else {
					u.each(usersFound, function(user){
						userIdToNicknameMap[user["id"]] = user["nickname"];
					});
				}
				next();
			});
		});

		var boardList;

		// ボードリスト取得処理関数を追加（移動先ボードリストとして利用）
		prerequisite.push(function(next) {
				Board.find({projectId: loginInfo["projectId"]})
				.where({ id: { 'not': boardId }})
				.sort({"title":-1})
				.exec(function(err4, boards) {
				if(err4) {
					logger.error(req, "ボードリストの取得: エラー発生: [" + JSON.stringify(err4) + "]");
					boardList = [];
					message = {type: "danger", contents: "エラーが発生しました。"};
					Utility.openMainPage(req, res, message);
					return;
				} else {
					boardList = boards || [];
				}

			// コールバック関数終了時にnext()を呼び出す。
			next();
		    });
		})

		// 前提とするすべての処理が完了した後で実行する関数（ビュー生成関数のラッパー生成）
		var done = function (){

			// DBから取得した利用可能付箋データから表示用データを抽出する。
			var ticketData = found["ticketData"] || BOARD_DEFAULT_VALUES["ticketData"];
			var ticketToUse = getTicketToUse(req, ticketData);

			// プルダウンメニューHTML設定
			comboMenu = createComboMenu(ticketToUse);

			// コンテクストメニューHTML設定
			contextMenu = createContextMenu(ticketToUse);

			// 各チケットにユーザーのニックネームを追加
			u.each(tickets, function(ticket){
				var createUser = ticket["createUser"];
				var nickname = userIdToNicknameMap[createUser];
				ticket["nickname"] = nickname ? nickname : "none";
			});

		    var obj = {
				comboMenu: comboMenu, // プルダウンメニューHTML
				contextMenu: contextMenu, // コンテクストメニューHTML
				boardId: boardId,
				category : req.param("category"),
				selectedId : req.param("selectedId"),
				loginInfo: loginInfo,
				title : found["title"],
				description: found["description"],
				ticketData : tickets,
				boardList : boardList,
				list : tickets,
				width: found["width"],
				height: found["height"],
				bgImage: found["bgImage"],
				bgRepeatType: found["bgRepeatType"],
				bgSepV: found["bgSepV"],
				bgSepH: found["bgSepH"],
				bgSepLineWidth: found["bgSepLineWidth"],
				bgSepLineColor: found["bgSepLineColor"],
				canvasAppearance: Utility.getCanvasAppearance(found),
				boardAppearance: Utility.getBoardAppearance(found)
			};
			res.view(obj);
		};

		// 同期処理実行
		wait(prerequisite, done);
	    });
    	});
    },

	/**
	 * ボード情報変更画面を開く
	 */
    editBoard : function(req, res) {
		var id = req.param("selectedId");
	    logger.trace(req, "editBoard: [" + id + "]");
	    var loginInfo = Utility.getLoginInfo(req, res);
		showEditView(req, res, id, loginInfo);
	},


    /**
     * ボード作成画面を開く
     */
    createBoard : function(req, res) {
    	logger.trace(req, "createBoard");
    	res.redirect('/newboard/index');
    },

    /**
     * ファイルのアップロード
     */
	uploadImageFile: function  (req, res) {
		logger.trace(req, "uploadImageFile");

		// GET経由でのアップロードは許可しない。
		if(req.method === 'GET'){
			logger.warn(req, "GETによるファイルアップロード要求が送られました。");
			return res.json({status: 'error', message : "処理が不正です。"});
		}
		var uploadFile = req.file('uploadFile');

		// 画像ファイルとして指定した拡張子以外の場合には、アップロードを行わない。
		var fileName = uploadFile._files[0].stream.filename;
		logger.info(req, "アップロード対象ファイル名:["+fileName+"]");
		if(!isImageFile(fileName)){
			logger.error(req, "ファイルアップロード処理 失敗: 不正な拡張子[" + fileName + "]");
			var message = "ファイル["+fileName+"]のアップロードに失敗しました。"
			+ "アップロードできる画像ファイルの拡張子は以下です：\n"
			+ IMAGE_FILE_EXTENSIONS;
			return res.json({status: 'error', message : message});
		}


		var boardId = req.param("selectedId");
		var loginInfo = Utility.getLoginInfo(req, res);

		var projectId = loginInfo["projectId"];
		logger.info(req, "ファイルアップロード処理: [" + boardId + "][" + uploadFile + "]["+projectId+"]");
		// ファイルのアップロード処理
		uploadFile.upload({dirname: getBackgroundDir(req, res)}, function onUploadComplete (err, files) {
			if (err) {
				logger.error(req, "ファイルアップロード処理 失敗[" + JSON.stringify(err) + "]");
				return res.json({status: 'error', message : "ファイルのアップロードに失敗しました。", error: err});
			}

			// アップロードしたファイル名の取得
			var filename = "";
			if(files &amp;&amp; files.length > 0){
				filename = files[0].filename;
			}
			logger.info(req, "ファイルアップロード処理 成功: [" + filename + "]");
			return res.json({status: 'success', src : BACKGROUND_REL_PATH + projectId + "/" + filename});
		});
	},

	/**
	 * ファイル削除処理
	 */
	deleteImageFile: function  (req, res) {
		logger.trace(req, "deleteImageFile");

		// GET経由での削除は許可しない。
		if(req.method === 'GET'){
			logger.warn(req, "GETによるファイル削除要求が送られました。");
			return res.json({status: 'error', message : "処理が不正です。"});
		}

		var path = req.param("deleteImage");
		logger.debug(req, "削除対象ファイル:[" + path + "]");

		// 削除対象ファイルのチェックを行う。
		// チェックＯＫの場合には、画像フォルダ名とファイル名が返される。
		var result = processDeleteImagePath(path);
		if(result == null){
			logger.error(req, "画像ファイル名が不正です:[" + path + "]");
			return res.json({status: 'error', message : "画像ファイル名が不正です:[" + path + "]"});
		}

		// 画像ファイル名
		var fileName = result.fileName;

		// 画像フォルダ名
		var imageDir = result.dirName;

		// デフォルト画像（commonフォルダに入っている画像）は削除できない。
		if(imageDir === "common"){
			return res.json({status: 'error', message : "デフォルト画像は削除できません。"});
		}

		logger.debug(req, "ファイル削除処理: [" + path + "][" + fileName + "]");

		// 指定された画像ファイルを削除する。
		var deletePath = getBackgroundDir(req, res) + fileName;
		var ret;
		fs.unlink(deletePath, function (err) {
			if (err) {
				logger.error(req, "ファイル削除処理 失敗: [" + JSON.stringify(err) + "]");
				ret = {status: 'error', message : "画像の削除に失敗しました。", error: err};
			 } else {
				logger.info(req, "ファイル削除処理 成功: [" + deletePath + "]");
				ret = {status: 'success', src : BACKGROUND_REL_PATH + fileName};
			}
			return res.json(ret);
		});
	},

	getImageFileList : function(req, res) {
		logger.trace(req, "getImageFileList");
		var loginInfo = Utility.getLoginInfo(req, res);
		var projectId = loginInfo["projectId"];
		fs.readdir(getBackgroundDir(req, res), function(err, files){
			if (err) {
				logger.error(req, "画像ファイルリスト取得処理 失敗: [" + JSON.stringify(err) + "]");
				return res.json({status: 'error', error: err});
			}

			// デフォルト背景画像
			var defaultImages = ["background02.gif", "kpt.png", "todo.gif"];

			var backgroundFileList = [];

			// デフォルト画像を追加
			u.each(defaultImages, function(fileName){
				backgroundFileList.push(BACKGROUND_REL_PATH + "common/" + fileName);
			});

			files.filter(function(file){
				// .で始まるファイルは表示対象外とする。
				return fs.statSync(getBackgroundDir(req, res) + file).isFile() &amp;&amp; isImageFile(file);
			}).forEach(function (file) {
				backgroundFileList.push(BACKGROUND_REL_PATH + projectId +"/"+file);
			});
			logger.debug(req, "画像ファイルリスト取得処理 成功: [" + backgroundFileList + "]");
			return res.json({status: 'success', images: backgroundFileList});
		});
	}
};

/**
 * 画像ファイルか否かを判定する。
 * @param file ファイル名
 * @returns 画像ファイルであればtrue, そうでない場合はfalse.
 */
function isImageFile(file){
	if(us.startsWith(file, ".") || file.indexOf('.') &lt; 0){
		return false;
	}
	var ext = path.extname(file).toUpperCase();
	ext = us.strRightBack(ext, ".");
	var ret = u.contains(IMAGE_FILE_EXTENSIONS, ext);
	return ret;
}

/**
 * チケット個別スタイルを生成
 * @param list チケットタイプリスト
 * @returns {String} スタイル文字列
 */
function createCss(ticketTypeList){
	var ret = "";
	u.each(ticketTypeList, function(ticketType){
		ret += createCssOfImage(ticketType);
	});
	return ret;
}

/**
 * チケット個別スタイル情報ファイルの内容からスタイルHTMLを作成する。
 *
 * 各行の先頭にクラス名を追加する。空行は無視する。
 */
function addMainClassName(mainClassName, contents){
	var lines = contents.replace(/\r/g, "").split("\n");
	var ret = u.map(lines, function(line){
		if(/^\s*$/.test(line)){
			//チケット空行のためスキップ
			return "";
		} else {
			return mainClassName + line;
		}
	}).join('\r\n');
	return ret;
}

/**
 * チケット単位の個別スタイル生成
 * @param ticketType チケットタイプ
 * @returns {String} スタイル文字列
 */
function createCssOfImage(ticketType){
	var imageFileName = ticketType["imageFileName"];
	var contents = ticketType["contents"];
	var className = imageFileName.substring(0, imageFileName.indexOf("."));
	var ret = "";
	if(contents){
		ret += addMainClassName("." + className, contents);
	}
	return ret;
}

/**
 * コンボボックスメニューHTML作成
 * @param displayTickets 対象ボードで利用可能なチケットタイプのリスト
 * @returns HTML文字列
 */
function createComboMenu(displayTickets){
	var ret = u.map(displayTickets, function(displayTicket){
	   return '&lt;option value="'+ displayTicket.name + '">'+ displayTicket.display + '&lt;/option>';
    }).join("\r\n");
	return ret + "\r\n";
}

/**
 * コンテクストメニューHTML作成
 * @param displayTickets 対象ボードで利用可能なチケットタイプのリスト
 * @returns HTML文字列
 */
function createContextMenu(displayTickets){
	var ret = u.map(displayTickets, function(item){
	   return '{title: "'+item.display+'", cmd: "'+item.name+'"}';
    }).join("\r\n,");
	return ret;
}

function getTicketToUse(req, ticketData){
	var array = createTicketDataArray(req, ticketData);
	// stateが"checked"の要素を抽出する。
	var ret = [];
	u.each(array, function(elem) {
		if(elem["state"] === "checked"){
			ret.push({name: elem["id"], display: elem["name"]});
		}
	});
	return ret;
}
</pre>
    </article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>

<div class="modal fade" id="searchResults">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Search results</h4>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div>

<footer>


	<span class="copyright">
	DocStrap Copyright © 2012-2015 The contributors to the JSDoc3 and DocStrap projects.
	</span>

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a>
	
		on Sun Jul 10th 2016
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>
<script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>

<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			var id = $( heading ).attr( "id" );
			return id && id.replace(/\~/g, '-inner-').replace(/\./g, '-static-') || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->


<script type="text/javascript">
	$(document).ready(function() {
		SearcherDisplay.init();
	});
</script>

</body>
</html>
